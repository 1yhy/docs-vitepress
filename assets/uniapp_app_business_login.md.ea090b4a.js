import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.c3fd347f.js";const b=JSON.parse('{"title":"第十三集 登录","description":"","frontmatter":{},"headers":[],"relativePath":"uniapp/app/business/login.md","filePath":"uniapp/app/business/login.md","lastUpdated":1707147609000}'),p={name:"uniapp/app/business/login.md"},e=l(`<h1 id="第十三集-登录" tabindex="-1">第十三集 登录 <a class="header-anchor" href="#第十三集-登录" aria-label="Permalink to &quot;第十三集 登录&quot;">​</a></h1><h2 id="_1-前置条件" tabindex="-1">1. 前置条件 <a class="header-anchor" href="#_1-前置条件" aria-label="Permalink to &quot;1. 前置条件&quot;">​</a></h2><ul><li>需要配置好manifest.json文件的第三方登录模块</li><li>配置好后，需要重新打包自定义基座，才能生效</li></ul><h2 id="_2-微信登录" tabindex="-1">2. 微信登录 <a class="header-anchor" href="#_2-微信登录" aria-label="Permalink to &quot;2. 微信登录&quot;">​</a></h2><h3 id="_2-1-填写微信登录的appid" tabindex="-1">2.1. 填写微信登录的appid <a class="header-anchor" href="#_2-1-填写微信登录的appid" aria-label="Permalink to &quot;2.1. 填写微信登录的appid&quot;">​</a></h3><ul><li>安卓：打开项目的manifest.json文件，在“App模块配置”项的“OAuth(登录鉴权)”下，勾选“微信登录”，将<a href="https://open.weixin.qq.com/" target="_blank" rel="noreferrer">微信开放平台</a>申请应用的AppID值填入“AppID”中</li><li>ios：打开项目的manifest.json文件，打开源码视图，找到<code>OAuth</code>项下的<code>UniversalLinks</code>，将<a href="https://open.weixin.qq.com/" target="_blank" rel="noreferrer">微信开放平台</a>申请应用的iOS平台通用链接值填入,必须与微信开放平台配置的一致</li><li>配置完成后进行打包自定义基座，才能生效</li></ul><h3 id="_2-2-调用微信登录" tabindex="-1">2.2. 调用微信登录 <a class="header-anchor" href="#_2-2-调用微信登录" aria-label="Permalink to &quot;2.2. 调用微信登录&quot;">​</a></h3><h4 id="_2-2-1-调用uni-login-获取临时票据code" tabindex="-1">2.2.1. 调用uni.login()获取临时票据code <a class="header-anchor" href="#_2-2-1-调用uni-login-获取临时票据code" aria-label="Permalink to &quot;2.2.1. 调用uni.login()获取临时票据code&quot;">​</a></h4><ol><li>客户端调用api向微信请求授权，获取临时票据（code），向开发者业务服务器发起网络请求</li><li>业务服务器通过code + 仅保存在服务器的appsecret参数，向：微信开放平台接口发起网络请求详情。</li><li>业务服务器成功获取用户信息后，再依据unionid或openid查数据库的用户表并生成新token，并返回token给客户端</li><li>客户端得到token后，保存到storage完成登录。</li></ol><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">uni.</span><span style="color:#B392F0;">login</span><span style="color:#E1E4E8;">({ </span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;provider&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;weixin&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;onlyAuthorize&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 微信登录仅请求授权认证</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">success</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">event</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> {</span><span style="color:#79B8FF;">code</span><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> event</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">//客户端成功获取授权临时票据（code）,向业务服务器发起登录请求。</span></span>
<span class="line"><span style="color:#E1E4E8;">		uni.</span><span style="color:#B392F0;">request</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">		    url: </span><span style="color:#9ECBFF;">&#39;https://www.example.com/loginByWeixin&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">//仅为示例，并非真实接口地址。</span></span>
<span class="line"><span style="color:#E1E4E8;">		    data: {</span></span>
<span class="line"><span style="color:#E1E4E8;">		        code: event.code</span></span>
<span class="line"><span style="color:#E1E4E8;">		    },</span></span>
<span class="line"><span style="color:#E1E4E8;">		    </span><span style="color:#B392F0;">success</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		        </span><span style="color:#6A737D;">//获得token完成登录</span></span>
<span class="line"><span style="color:#E1E4E8;">				uni.</span><span style="color:#B392F0;">setStorageSync</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;token&#39;</span><span style="color:#E1E4E8;">,res.token)</span></span>
<span class="line"><span style="color:#E1E4E8;">		    }</span></span>
<span class="line"><span style="color:#E1E4E8;">		});</span></span>
<span class="line"><span style="color:#E1E4E8;">	},</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">fail</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 登录授权失败  </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// err.code是错误码</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">uni.</span><span style="color:#6F42C1;">login</span><span style="color:#24292E;">({ </span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;provider&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;weixin&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;onlyAuthorize&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">// 微信登录仅请求授权认证</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">success</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">function</span><span style="color:#24292E;">(</span><span style="color:#E36209;">event</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> {</span><span style="color:#005CC5;">code</span><span style="color:#24292E;">} </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> event</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">//客户端成功获取授权临时票据（code）,向业务服务器发起登录请求。</span></span>
<span class="line"><span style="color:#24292E;">		uni.</span><span style="color:#6F42C1;">request</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">		    url: </span><span style="color:#032F62;">&#39;https://www.example.com/loginByWeixin&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">//仅为示例，并非真实接口地址。</span></span>
<span class="line"><span style="color:#24292E;">		    data: {</span></span>
<span class="line"><span style="color:#24292E;">		        code: event.code</span></span>
<span class="line"><span style="color:#24292E;">		    },</span></span>
<span class="line"><span style="color:#24292E;">		    </span><span style="color:#6F42C1;">success</span><span style="color:#24292E;">: (</span><span style="color:#E36209;">res</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		        </span><span style="color:#6A737D;">//获得token完成登录</span></span>
<span class="line"><span style="color:#24292E;">				uni.</span><span style="color:#6F42C1;">setStorageSync</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;token&#39;</span><span style="color:#24292E;">,res.token)</span></span>
<span class="line"><span style="color:#24292E;">		    }</span></span>
<span class="line"><span style="color:#24292E;">		});</span></span>
<span class="line"><span style="color:#24292E;">	},</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">fail</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">err</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 登录授权失败  </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// err.code是错误码</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_2-2-2-调用uni-getuserinfo-获取用户信息" tabindex="-1">2.2.2 调用uni.getUserInfo()获取用户信息 <a class="header-anchor" href="#_2-2-2-调用uni-getuserinfo-获取用户信息" aria-label="Permalink to &quot;2.2.2 调用uni.getUserInfo()获取用户信息&quot;">​</a></h4><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">uni.</span><span style="color:#B392F0;">getUserInfo</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  provider: </span><span style="color:#9ECBFF;">&#39;weixin&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">success</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">res</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获得用户信息</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> {</span><span style="color:#79B8FF;">userInfo</span><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> res</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">fail</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">err</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取用户信息失败</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// err.code是错误码</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">uni.</span><span style="color:#6F42C1;">getUserInfo</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">  provider: </span><span style="color:#032F62;">&#39;weixin&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">success</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">res</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获得用户信息</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> {</span><span style="color:#005CC5;">userInfo</span><span style="color:#24292E;">} </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> res</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">fail</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">err</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取用户信息失败</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// err.code是错误码</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_3-参考文档" tabindex="-1">3. 参考文档 <a class="header-anchor" href="#_3-参考文档" aria-label="Permalink to &quot;3. 参考文档&quot;">​</a></h2><ul><li><a href="https://uniapp.dcloud.net.cn/api/plugins/login.html" target="_blank" rel="noreferrer">uni.login</a></li><li><a href="https://open.weixin.qq.com/" target="_blank" rel="noreferrer">微信开放平台</a></li><li><a href="https://developers.weixin.qq.com/doc/oplatform/Mobile_App/WeChat_Login/Development_Guide.html#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%80%9A%E8%BF%87-code-%E8%8E%B7%E5%8F%96-access-token" target="_blank" rel="noreferrer">通过code获取access_token</a></li><li><a href="https://developers.weixin.qq.com/doc/oplatform/Mobile_App/WeChat_Login/Development_Guide.html#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF" target="_blank" rel="noreferrer">微信获取用户信息</a></li><li><a href="https://www.html5plus.org/doc/zh_cn/oauth.html" target="_blank" rel="noreferrer">plus.oauth</a></li></ul>`,14),o=[e];function t(r,c,i,E,y,u){return n(),a("div",null,o)}const h=s(p,[["render",t]]);export{b as __pageData,h as default};
